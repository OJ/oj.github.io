<!DOCTYPE html>
<html>
   <head>
   <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>
    
    
    TLV Traffic Obfuscation - OJ&#39;s Perspective
    
  </title>
  <link rel="shortcut icon" href="/favicon.ico" />
  
     <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/bootstrap-theme.min.css">

  <script src="/js/jquery.min.js"></script>
  <script src="/js/bootstrap.min.js"></script>
  <script src="/js/holder.min.js" type='text/javascript'></script>
  <link rel="stylesheet" href="/highlight/styles/github-gist.css">  
  <link rel="stylesheet" href="/css/style.css">

  <link rel="canonical" href="/posts/tlv-traffic-obfuscation/">
  
  <script src="/highlight/highlight.pack.js" type='text/javascript'></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.3.0/highlightjs-line-numbers.min.js"></script>
  <script type="text/javascript">

    $(document).ready(function() {
    
    hljs.initHighlightingOnLoad();
    $('pre code').each(function(i, block) {
    hljs.highlightBlock(block);
    hljs.lineNumbersBlock(block);
    });
});
  </script>
   </head>
   <body data-spy="scroll" data-target="#toc">
     <header class="navbar navbar-default navbar-fixed-top" id="top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">OJ&#39;s Perspective</a>
    </div>

    
    <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
      <ul class="nav navbar-nav">
	
	
	<li  ><a href="/">Home</a></li>
	
	

	

	

	

	

	

	

	

	
	
	<li > <a href="/streaming/" >Live Streaming</a></li>
	

	

	
	
	<li > <a href="/about/" >About</a></li>
	

	
	
	<li > <a href="/contact/" >Contact</a></li>
	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

      </ul>
</nav>
</header>

     <div class="jumbotron masthead" role="main">
       <div class="container">
	 <div class="row">

 	   <div class="col-md-8 col-md-offset-2 ">
	   
<div class="panel panel-default">
  <div class="panel-body">
      <article id='post' >
	<h1> TLV Traffic Obfuscation </h1>
	  
	  <span class="text-muted">Posted by:&nbsp;Mon Feb 22, 2016</span>

	  <p>As many of you are already aware, Metasploit and Meterpreter talk to each other using a variety of transports. While the transports may vary from session to session, one thing that doesn&rsquo;t vary is the &ldquo;protocol&rdquo; that travels over those transports. This information fits a well-known structure, and is referred to as <em>TLV Packets</em> (Type, Length, Value).</p>

<p>Once a session has been established, the TLV traffic that is sent across the wire contains a bunch of very easily recognisable content, and as such can be detected by Antivirus software, or Intrusion Detection Systems.</p>

<p>Recently, I made a change to the way the packets are formed prior to transmission, and this post is intended to explain the detail of how it works.</p>

<p>Warning: It&rsquo;s <em>really simple</em>.</p>

<h2 id="the-core-problem">The Core Problem</h2>

<p>Every command that Meterpreter supports is identified by a string. This string is sent in the TLV packet so that Meterpreter can match the command with the appropriate functionality. The <a href="https://github.com/rapid7/metasploit-payloads/blob/master/c/meterpreter/source/server/remote_dispatch_common.c#L18">core commands</a> contain values that are <em>very clearly</em> Meterpreter-related, such as <code>core_loadlib</code> and <code>core_patch_url</code>. There are a bunch more in the <a href="https://github.com/rapid7/metasploit-payloads/blob/master/c/meterpreter/source/extensions/stdapi/server/stdapi.c#L21">stdapi commands</a> that look even more suspicious, such as <code>stdapi_sys_process_execute</code> and <code>stdapi_sys_process_memory_allocate</code>. Clearly, if those strings are visible in some network traffic, you&rsquo;ve probably got a Meterpreter session running somewhere. Depending on your perspective, this could be considered a bad thing!</p>

<p>In the case of both <code>reverse_tcp</code> and <code>reverse_https</code> payloads, this content is encrypted. In the case of <code>reverse_http</code> (which isn&rsquo;t used that often) the content is in the clear. However, many environments have AV or IDS software that man-in-the-middles SSL traffic, and so the TLV content is made visible, rendering <code>reverse_https</code> as vulnerable as <code>reverse_http</code>.</p>

<p>Many defensive solutions actively review traffic on the wire, and so many of the known TLV commands were being picked up through very simple signature-based detection (ie. string pattern matching). It was beyond time to do something about it.</p>

<h2 id="the-fix">The &ldquo;Fix&rdquo;</h2>

<p>Note: &ldquo;Fix&rdquo; is in air quotes because this is a game of cat and mouse. We aren&rsquo;t really fixing anything, we&rsquo;re just changing it enough so that the defenders have to level up.</p>

<p>The main goal of the <a href="https://github.com/rapid7/metasploit-framework/pull/6480">PR</a> that addressed this concern was to make it so that every single TLV packet that was sent down the wire was obfuscated (not encrypted). The chosen approach did the following (for every packet):</p>

<ol>
<li>Generate the TLV packet as per usual.</li>
<li>Generate 4 separate non-<code>NULL</code> bytes, and combine them into a single 32-bit XOR key.</li>
<li>XOR the entire TLV packet with the 4-byte XOR key (cycled to match the entire payload length).</li>
<li>Write the XOR key to the socket first.</li>
<li>Finally write the XOR-ed packet to the socket.</li>
</ol>

<p>See, I told you it was simple.</p>

<p>The chosen key size was hard-coded to 4 because of <code>$REASONS</code>. I chose to make sure that each byte was not <code>NULL</code> because I wanted to see every byte in the payload change.</p>

<p>With this simple obfuscation technique, it was relatively easy to implement both encoding and decoding in MSF and in all of the separate Meterpreter implementations. The net effect is that the TLV packets never* look the same. Even if the same command is sent down the wire, the TLV packet will have a different XOR key, and hence a different signature.</p>

<p>As far as defense goes, vendors will have to begin parsing the content if they are to continue using signature-based techniques. Or do something smarter. Either way, the ball is now in their court.</p>

<p>I tested this against 4 different AV applications, and 2 different IDSs, using <code>reverse_http</code> (deliberately visible). Prior to the change, they all interfered with and caught TLV traffic. After the change, none of them did.</p>

<p>No, I will not name any of them!</p>

<h2 id="no-more-recv">No More RECV</h2>

<p>While I was at it, I wanted to remove another very obvious issue that <a href="http://blog.didierstevens.com/2015/05/11/detecting-network-traffic-from-metasploits-meterpreter-reverse-http-module/">Didier Stevens had posted about</a> a while back. Both <code>reverse_http</code> and <code>reverse_https</code> transports in Meterpreter were polling Metasploit via <code>POST</code> requests to determine if there commands to be executed. The <em>body</em> of the request contained a single, hard-coded word: <code>RECV</code>. Talk about easy to find!</p>

<p>As of this changeset, Meterpreter now uses <code>GET</code> requests, and does not specify any body content. No more <code>RECV</code> to be found. Things look way more like &ldquo;legit&rdquo; HTTP at this point. I didn&rsquo;t test the impact of this change on the Snort rules that were mentioned in Didier&rsquo;s post, however I&rsquo;m sure that some changes will be required after this.</p>

<p>As a side note, I got to meet Didier at 44con in 2015. What an awesome dude. <code>#achievementunlocked</code></p>

<h2 id="comments-and-suggestions">Comments and Suggestions</h2>

<p>As always, feedback is welcomed and encouraged. I can, however, answer a few simple ones right now.</p>

<blockquote>
<p>This is beyond trivial. You could have done so much more. Why didn&rsquo;t you?</p>
</blockquote>

<p>Because this is, for now, more than enough. It was simple, easy to implement, and didn&rsquo;t add that much overhead to the communication process.</p>

<blockquote>
<p>AV and IDS will level up quickly, what will you do then?</p>
</blockquote>

<p>They <em>will</em> level up (I hope). I doubt it&rsquo;ll be too quick though. If it is, we have more modifications in the wings ready to rock. As I said, it&rsquo;s a game of cat and mouse.</p>

<blockquote>
<p>Does this also cover the staging process?</p>
</blockquote>

<p>No, this implementation is for Meterpreter&rsquo;s TLV traffic only. At this point, the staging process is still prone to being owned by traffic inspection, as <code>metsrv</code> is still sent in the raw. Stageless payloads with <code>metsrv</code> baked-in are definitely better if you&rsquo;re able to take that option.</p>

<blockquote>
<p>I can do way better!</p>
</blockquote>

<p>Yup, you probably can. I look forward to checking out your Pull Request!</p>

<h2 id="thanks">Thanks</h2>

<p>Kudos and appreciation goes out to all the fine people who helped, commented, tested and fixed up my crappy work. In random order, they are Brent, Wvu, RageLtMan, Egypt, Hdm, Timwr and zeroSteiner. You&rsquo;re all awesome.</p>

<p><small>* For small values of &lsquo;never&rsquo;.</small></p>

	  
	  	  <div class="tags">	
	    <p class="categories">
	  
	  <a class="btn btn-default btn-xs text-capitalize" href="/categories/metasploit">Metasploit</a>
	  
	  <a class="btn btn-default btn-xs text-capitalize" href="/categories/meterpreter">Meterpreter</a>
	  
	  <a class="btn btn-default btn-xs text-capitalize" href="/categories/security">Security</a>
	  
	    </p>
	    

	    	  </div>
	    


<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "ojsrants" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

      </div>
      </div></article>


	 </div>

	 </div>
       </div>
     </div>

 <div class="container footer">
  <div class="row">
    <div class="col-md-10">
      <small class="text-muted">Copyright OJ Reeves 2019 Theme:<a href="https://feiio.com/">eiio</a></small>
    </div>
    <div class="col-md-2">
      <small class="text-muted">Trying to make the Internet less shit, one bit at a time.</small>
      </div>
   </div>
 </div>
</body></html>
